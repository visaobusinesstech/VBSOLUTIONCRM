<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deploy Edge Function - SMTP Real</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        .content {
            padding: 40px;
        }
        .alert {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            color: #1565c0;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .alert.success {
            background-color: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .alert.warning {
            background-color: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .steps {
            margin: 30px 0;
        }
        .step {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }
        .step h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        .step-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 15px;
            font-size: 1.2em;
        }
        .code-container {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            max-height: 500px;
            overflow-y: auto;
        }
        .code-container pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .btn-group {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        .success-msg {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .link-box {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .link-box a {
            color: #667eea;
            font-size: 1.2em;
            font-weight: bold;
            text-decoration: none;
        }
        .link-box a:hover {
            text-decoration: underline;
        }
        .checklist {
            list-style: none;
            padding: 0;
        }
        .checklist li {
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .checklist li:before {
            content: "‚úÖ ";
            margin-right: 10px;
        }
        .icon {
            font-size: 3em;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="icon">üöÄ</div>
            <h1>Deploy Edge Function</h1>
            <p>SMTP Real - send-email-real</p>
        </div>
        
        <div class="content">
            <div class="alert success">
                <strong>‚úÖ Pronto para Deploy!</strong><br>
                A edge function est√° pronta para ser implantada no Supabase. Siga os passos abaixo.
            </div>

            <div class="steps">
                <div class="step">
                    <h3><span class="step-number">1</span>Acesse o Supabase Dashboard</h3>
                    <p>Clique no bot√£o abaixo para abrir o Supabase Dashboard:</p>
                    <div class="link-box">
                        <a href="https://supabase.com/dashboard" target="_blank">üîó Abrir Supabase Dashboard</a>
                    </div>
                    <ul class="checklist">
                        <li>Fa√ßa login na sua conta</li>
                        <li>Selecione o projeto VB-Solution-CRM</li>
                    </ul>
                </div>

                <div class="step">
                    <h3><span class="step-number">2</span>Navegue at√© Edge Functions</h3>
                    <p>No menu lateral esquerdo do Supabase:</p>
                    <ul class="checklist">
                        <li>Clique em <strong>"Edge Functions"</strong></li>
                        <li>Clique no bot√£o <strong>"Create a new function"</strong> ou <strong>"New Function"</strong></li>
                    </ul>
                </div>

                <div class="step">
                    <h3><span class="step-number">3</span>Configure a Fun√ß√£o</h3>
                    <p>Preencha os campos:</p>
                    <ul class="checklist">
                        <li><strong>Nome da fun√ß√£o:</strong> <code>send-email-real</code></li>
                        <li>Marque <strong>"Execute with elevated privileges"</strong> (se dispon√≠vel)</li>
                    </ul>
                </div>

                <div class="step">
                    <h3><span class="step-number">4</span>Cole o C√≥digo da Fun√ß√£o</h3>
                    <p>Copie o c√≥digo abaixo clicando no bot√£o:</p>
                    
                    <div class="btn-group">
                        <button class="btn" onclick="copyCode()">üìã Copiar C√≥digo da Edge Function</button>
                        <button class="btn" onclick="openFile()">üìÅ Abrir Arquivo index.ts</button>
                    </div>
                    
                    <div class="code-container" id="edgeFunctionCode">
<pre>import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.7.1';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const requestData = await req.json();
    console.log("üì® Recebida requisi√ß√£o de envio SMTP REAL:", {
      to: requestData.to,
      subject: requestData.subject,
      user_id: requestData.user_id,
      has_content: !!requestData.content
    });

    const supabase = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    );

    let smtpSettings = null;
    let settingsError = null;

    const { data: smtpData, error: smtpError } = await supabase
      .from('smtp_settings')
      .select('*')
      .eq('user_id', requestData.user_id)
      .eq('is_active', true)
      .single();

    if (smtpData) {
      smtpSettings = smtpData;
    } else {
      const { data: profileData, error: profileError } = await supabase
        .from('user_profiles')
        .select('smtp_host, email_porta, email_usuario, smtp_pass, smtp_from_name, smtp_seguranca')
        .eq('id', requestData.user_id)
        .single();

      if (profileData && profileData.smtp_host) {
        smtpSettings = {
          host: profileData.smtp_host,
          port: profileData.email_porta || 587,
          user: profileData.email_usuario,
          pass: profileData.smtp_pass,
          from_name: profileData.smtp_from_name,
          security: profileData.smtp_seguranca || 'tls'
        };
      } else {
        settingsError = profileError || new Error('Configura√ß√µes SMTP n√£o encontradas');
      }
    }

    if (settingsError || !smtpSettings) {
      console.error("‚ùå SMTP n√£o configurado:", settingsError);
      return new Response(
        JSON.stringify({ 
          success: false, 
          error: "Configura√ß√µes SMTP n√£o encontradas. Configure nas configura√ß√µes do sistema." 
        }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    if (!requestData.to || !requestData.subject || !requestData.content) {
      console.error("‚ùå Par√¢metros obrigat√≥rios faltando:", {
        to: !!requestData.to,
        subject: !!requestData.subject,
        content: !!requestData.content
      });
      return new Response(
        JSON.stringify({ 
          success: false, 
          error: 'Par√¢metros obrigat√≥rios: to, subject, content' 
        }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    console.log("üìß Configura√ß√µes SMTP encontradas:", {
      host: smtpSettings.host,
      port: smtpSettings.port,
      user: smtpSettings.user,
      security: smtpSettings.security
    });

    const nodemailer = await import('https://deno.land/x/nodemailer@1.0.0/mod.ts');
    
    const transporter = nodemailer.createTransporter({
      host: smtpSettings.host,
      port: parseInt(smtpSettings.port) || 587,
      secure: smtpSettings.security === 'ssl',
      auth: {
        user: smtpSettings.user,
        pass: smtpSettings.pass
      },
      tls: {
        rejectUnauthorized: false
      }
    });

    console.log("üì§ Enviando email via SMTP real...");

    const info = await transporter.sendMail({
      from: `"${smtpSettings.from_name || 'Sistema'}" <${smtpSettings.user}>`,
      to: requestData.to,
      subject: requestData.subject,
      html: requestData.content,
      attachments: requestData.attachments || []
    });

    console.log("‚úÖ Email enviado com sucesso:", {
      messageId: info.messageId,
      to: requestData.to,
      subject: requestData.subject
    });

    try {
      await supabase
        .from('email_logs')
        .insert({
          user_id: requestData.user_id,
          to_email: requestData.to,
          subject: requestData.subject,
          status: 'sent',
          message_id: info.messageId,
          sent_at: new Date().toISOString()
        });
      console.log("üìù Log de email salvo com sucesso");
    } catch (logError) {
      console.warn("‚ö†Ô∏è Erro ao salvar log:", logError);
    }

    return new Response(
      JSON.stringify({
        success: true,
        messageId: info.messageId,
        to: requestData.to,
        subject: requestData.subject,
        sentAt: new Date().toISOString(),
        message: 'Email enviado com sucesso via SMTP'
      }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );

  } catch (error) {
    console.error("‚ùå Erro no envio de email:", error);
    console.error("‚ùå Stack trace:", error.stack);
    
    return new Response(
      JSON.stringify({
        success: false,
        error: error.message || "Erro interno no servidor SMTP",
        timestamp: new Date().toISOString(),
        details: error.stack
      }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});</pre>
                    </div>
                    
                    <div class="alert warning">
                        <strong>‚ö†Ô∏è IMPORTANTE:</strong> Cole TODO o c√≥digo acima no editor do Supabase. N√£o esque√ßa nenhuma linha!
                    </div>
                </div>

                <div class="step">
                    <h3><span class="step-number">5</span>Fa√ßa o Deploy</h3>
                    <ul class="checklist">
                        <li>Revise o c√≥digo colado</li>
                        <li>Clique no bot√£o <strong>"Deploy"</strong> ou <strong>"Save"</strong></li>
                        <li>Aguarde a confirma√ß√£o de deploy bem-sucedido</li>
                    </ul>
                </div>

                <div class="step">
                    <h3><span class="step-number">6</span>Verifique o Deploy</h3>
                    <p>Confirme que:</p>
                    <ul class="checklist">
                        <li>A fun√ß√£o aparece na lista de Edge Functions</li>
                        <li>Status est√° como <strong>"Active"</strong> ou <strong>"Deployed"</strong></li>
                        <li>N√£o h√° erros no log</li>
                        <li>A URL da fun√ß√£o est√° dispon√≠vel</li>
                    </ul>
                </div>
            </div>

            <div class="alert success">
                <strong>üéâ Pronto!</strong><br>
                Ap√≥s o deploy, voc√™ pode testar o envio de emails diretamente no sistema.
            </div>

            <div class="success-msg" id="successMessage">
                ‚úÖ C√≥digo copiado com sucesso! Cole no Supabase Dashboard.
            </div>
        </div>
    </div>

    <script>
        function copyCode() {
            const code = document.getElementById('edgeFunctionCode').textContent;
            navigator.clipboard.writeText(code.trim()).then(function() {
                showSuccessMessage();
            }).catch(function(err) {
                alert('Erro ao copiar: ' + err);
            });
        }

        function showSuccessMessage() {
            const successMsg = document.getElementById('successMessage');
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
        }

        function openFile() {
            alert('Abra o arquivo: supabase/functions/send-email-real/index.ts');
        }
    </script>
</body>
</html>


